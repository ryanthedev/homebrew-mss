  name: Update Formula

  on:
    workflow_dispatch:
      inputs:
        version:
          description: 'Release version number'
          required: true
          type: string
        sha256:
          description: 'SHA256 checksum of the tarball'
          required: true
          type: string
        tarball_url:
          description: 'URL to download the release tarball'
          required: true
          type: string

  permissions:
    contents: write

  jobs:
    update:
      runs-on: ubuntu-latest

      steps:
        #########################################
        # STEP 1: Checkout Repository
        #########################################
        - name: Checkout
          uses: actions/checkout@v4

        #########################################
        # STEP 2: Update Formula
        #########################################
        - name: Update formula
          run: |
            VERSION="${{ inputs.version }}"
            SHA256="${{ inputs.sha256 }}"
            TARBALL_URL="${{ inputs.tarball_url }}"

            echo "Updating formula to version $VERSION"
            echo "SHA256: $SHA256"
            echo "Tarball URL: $TARBALL_URL"

            # Update version
            sed -i 's/version ".*"/version "'"$VERSION"'"/' Formula/mss.rb

            # Update URL
            sed -i 's|url ".*"|url "'"$TARBALL_URL"'"|' Formula/mss.rb

            # Update SHA256
            sed -i 's/sha256 ".*"/sha256 "'"$SHA256"'"/' Formula/mss.rb

            echo ""
            echo "Updated formula:"
            head -10 Formula/mss.rb

        #########################################
        # STEP 3: Commit and Push
        #########################################
        - name: Commit and push
          run: |
            VERSION="${{ inputs.version }}"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add Formula/mss.rb
            git commit -m "chore: update formula for mss v$VERSION"
            git push

            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "✅ Formula updated to version $VERSION"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
